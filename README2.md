# <font color="Seablue">cat_app</font>

***TypeScript／Next.jsで猫画像アプリを作る学習***

***参考サイト***

https://www.youtube.com/watch?v=MZclBqhCB6A

https://qiita.com/kenRp01/items/e4a5b08d7968aba855e1

https://www.commte.co.jp/learn-nextjs/next-head

https://commte.net/nextjs-google-font

https://thecatapi.com/


- TypeScriptをメイン言語、フレームワークをNext.jsとして、アプリケーションを作っていきます。
- 任意のディレクトリに移動して、
- Next.jsの導入コマンドを叩いていきます。
- 今回はTypeScriptも一緒にインストールするオプションをつけてコマンドを実行します。
- アプリ名は参考動画と同じにします。`cat_app`
- 今回はTypeScript以外のインストールで質問された項目は全てNoにしました。
- TailwindCSSや、srcディレクトリおよびApp routeも採用していません。
- 2022年9月の動画なので、1年以上経過していて若干古いです。
- が、まずはTypeScriptをメインに開発していく過程を学ぶのが主目的であるため、
- これで進めようと思います。
- また、今回は`npx`コマンドでプロジェクトを作成しました。
- ローカルのサーバーを確認するには、コマンド`npm rnn dev`で起動します。

<br>

## <font color="Seablue">開発環境</font>


- `Next.js 14.0.4`
- `TypeScript`
- `Vercel`



<br>


## <font color="Seablue">開発ログ</font>

```terminal
$ cd ~/workspace/create
$ npx create-next-app@latest --typescript
$ npm run dev
$ git remote add origin git@github.com:******/cat_app.git
$ git branch -M main
$ git push -u origin main
$ git checkout -b development
$ git add .
$ git commit -m "【Add】ファイルシステムルーティングを確認"
$ git push
$ git push --set-upstream origin development
$ git log
$ プルリクエスト
$ リモートでマージ
$ git checkout main
$ git pull origin main
$ git checkout development
$ Vercelへデプロイ
$ デプロイ先本番環境のサーバーからWebページを確認
```

<br>

### ***<font color="orange">`index.tsx`のコードを紐解く</font>***

```tsx
// ~/pages/index.tsx
// 全部は調べ切らなくて良いだろう。ひとまず、コード序盤の内容を調べました。
// Next.js アプリケーション内の React コンポーネントにおいて、HTML の <head> 要素を操作するために使用される特別なコンポーネント
import Head from 'next/head'
// Next.js アプリケーション内の React コンポーネントにおいて、HTML の <image> 要素を操作するために使用される特別なコンポーネント
import Image from 'next/image'
// Next.js アプリケーション内の React コンポーネントにおいて、googleフォントの「Inter」を適用するためのコンポーネント
import { Inter } from 'next/font/google'
// Next.js アプリケーション内の React コンポーネントにおいて、CSS Modulesを導入するための記述
import styles from '@/styles/Home.module.css'
// 定数interに対してInterフォントのサブセットで`latin`を指定している。Googleフォントに関する記述だと思われる。
const inter = Inter({ subsets: ['latin'] })

```

- ***オブジェクトのサブセットを得る***
`オブジェクトのサブセットを得る方法です。サブセットとは、あるオブジェクトのいち部分を切り取ったもので、ここで紹介する方法は、プロパティ名を指定してオブジェクトの一部分を切り出すものです。たとえば、次のような数多くのプロパティを持つオブジェクトがあるとき、ここから数個のプロパティだけを持つオブジェクトを作る方法です。`

https://typescriptbook.jp/tips/get-a-subset-of-an-object


<br>

- ***JavaScriptとTypeScriptの大きな違いは`型が付いていない・付いている`である。***

```tsx
// これは動画で紹介されている古いバージョンのNext.jsホーム画面のtsxファイルのソースコード

import type { NextPage } from 'next'
import Head from 'next/head' import Image from 'next/image'
import styles from '../styles/Home.module.css'

const Home: NextPage = () => {
    return (
    <div className={styles.container}>
        <Head>
            <title>Create Next App</title> <meta name="description" content="Generated by create next app" /> <link rel="icon" href="/favicon.ico" />
        </Head>
    <main className={styles.main}>
        <h1 className={styles.title}>
            Welcome to <a href="https://nextjs.org">Next.js!</a>
        </h1>
    <p className={styles.description}>
        Get started by editing{''} <code className={styles.code)>pages/index.tsx</code>
    </p>
    
// ...以下略
```

- 上記のコード例で言うと、、、
- `const Home:`の`Home`は`Home`という名前をつけた関数コンポーネントである。
- `NextPage`は型である。
- 上の行の`import type { NextPage }`によって、NextPageという型が挿入されている。
- 関数コンポーネント`Home`は、`Next.js`公式が用意した`NextPage`で定義してますよ。ということを明確に示すための記述である。
- Next.jsとTypeScriptを用いて開発する際は、概ね、`NextPage`という型を指定してあげることになる。
- ただし、これはおそらくバージョン12以前のindexページの実装なので、バージョン14の2024/01/07時点では、また、少し違った型が定義されているのかなぁと思われる。
- まぁ、とりあえずは、こんなものがあるんだなぁ、くらいの感覚で認識しておく程度で良いでしょう。とのこと。
- 型をつける事により、VScode上（エディタ）でエラーをいち早く察知できるようになるのがメリットらしい。
- 以下のようなエラー表記が確認できるようになる。


<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3486945/c8497a06-12c7-a47a-ec92-f4dbdf4d1c6c.jpeg" alt="代替テキスト" width=50% height=50%>



<br>
<hr>


### ***<font color="orange">`index.tsx`に実装開始</font>***

***<font color="Red">動画05分20秒付近から</font>***

- 今回は`index.tsx`のページのコードの大部分を削除してしまって、ここにアプリケーション機能を実装していきます。
- ここまで削除してしまいます。

```tsx
// ~/pages/index.tsx

import Head from 'next/head'
import Image from 'next/image'
import { Inter } from 'next/font/google'
import styles from '@/styles/Home.module.css'

const inter = Inter({ subsets: ['latin'] })

export default function Home() {
  return (
    <>
    </>
  )
}
```

- 上記まで不要なコードを削ぎ落としたら、
- 最低限の見た目を作るための雛形を作っていきます。
- `export default function Home() {}`配下にCSSを当てていきます。


```tsx
export default function Home() {
  return (
    <div className={styles.container}>
      <h1>猫画像アプリ</h1>
    </div>
  );
};
```
- ここまでの実装で、`localhost:3000`で確認するとこんな感じ。

<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3486945/73186494-1ed3-bb67-7867-23f9376a6983.jpeg" alt="代替テキスト" width=50% height=50%>

- どんどん実装していきます。
- ここまで実装して、再度ブラウザを確認します。

```tsx
export default function Home() {
  return (
    <div className={styles.container}>
      <h1>猫画像アプリ</h1>
      <img src="" alt="" />
      <button>今日の猫さん</button>
    </div>
  );
};
```

<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3486945/0dac6f4e-dabd-860f-c743-a33eaf72ae03.jpeg" alt="代替テキスト" width=50% height=50%>

- imgタグには、猫画像を取得するAPIで取得した画像を載せるようにしていきますが、
- まだ実装段階ではないので、一旦タグだけ設置しておいています。
- また、`styles.container`のプロパティ名？は、まだ`Home.module.css`には実装されていないので、スタイルは当たっていない状態。
- 後程、`Home.module.css`にスタイルのコードを記述する必要がありあそうです。


### ***<font color="orange">猫画像を取得するAPIの確認とスタイルの調整</font>***

***<font color="Red">動画06分05秒付近から</font>***

- 今回使用するAPIは`the cat api`

https://thecatapi.com/

- 公式サイトのドキュメントメニューに進む。
- ここのリンクを開くと、ランダムで猫画像が保存されたURLが表示される。
- そのURLにアクセスすると猫画像が見れる。
- リロードすると、自動的にまたランダムの猫画像が取得される。
- https://api.thecatapi.com/v1/images/search
- 今回はこちらの画像を使用させてもらいます。
- https://cdn2.thecatapi.com/images/1v1.jpg


```json
[
    {
        "id":"1v1",
        "url":"https://cdn2.thecatapi.com/images/1v1.jpg",
        "width":320,
        "height":320
    }
]
```

- 一旦、この画像をトップに置いておきます。
- 教材動画では`index.tsx`に直接スタイルを記述していますが、
- 自分のコード上では`<div className={styles.container}>`が定義されています。
- せっかくなのでこれを利用します。
- `Home.module.css`ファイルに新しく`.container`を定義して、ここにCSSスタイルを適用していきます。
- スタイルは結構適当です。


```css
/* Home.module.css */

.container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100vh;
}

.container h1 {
  margin-bottom: 15px;
}

.container img {
  width: 350px;
  height: auto;
}

.container button {
  margin-top: 20px;
}

```

- 以下、`index.tsx`に任意の画像を乗っけたファイルのコードです。

```tsx
// index.tsx

export default function Home() {
  return (
    <div className={styles.container}>
      <h1>猫画像アプリ</h1>
      <img src="https://cdn2.thecatapi.com/images/1v1.jpg" alt="cat_image" />
      <button>今日の猫さん</button>
    </div>
  );
};
```

- 一旦、`localhost:3000`でWebブラウザを確認します。

<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3486945/5f15836d-c07c-eca3-f1bd-1ab19cf2ec8c.jpeg" alt="代替テキスト" width=50% height=50%>

- 見た目はいい感じに収まりました。
- ここで一旦、コミットしておきます。


### ***<font color="orange">いよいよAPIを叩いていく！</font>***

***<font color="Red">動画08分47秒付近から</font>***

- `button`を押したときに、APIが走るようにしたい。
- TypeScriptの`onClick`イベントが発火するように実装する。
- 具体的には、、、、
    - まず`index.tsx`の`<button>`タグに`onClick=`のイベントを定義。
    - この`onClick`イベントには任意の関数名`fetchCatImage`といった名前をつける。
    - 次に、定義づけた関数`fetchCatImg`の処理について、`export default function Home() {}`の直下に実装していく。


<br>

***メモ***

- `async`は非同期処理でAPIを実装するときに使うおまじない。アロー関数の手前に定義する。
- `await`の`fetch`という関数が備わっているやつを使用している。
- これも一旦おまじないと思っておく。奥が深そう。
- URLは`the cat api`が指定しているAPIのURLを使用している。
- `fetch`は日本語だと`読み込む`とか`取ってくる`みたいな意味。
- これら自体は`JavaScript`の構文。
- 当然、`TypeScript`でも使える。
- `const res`を手前につけてあげて、叩いたAPI情報を受け取ることができる。
- さらに受け取った情報をJSON形式で受け取りたいので、`const result`定数で`res.json();`としてあげる。
- ここにも忘れずに`await`をつけてあげる。
- そして、受け取ったJSONファイルを`console.log`で出力する。
- 一度デベロッパーツールで確認するとわかるが、JSON形式の取得したファイルは、配列の0番目の要素の中にハッシュ形式で4つの属性（プロパティ）全てが格納されている。
- よって今回は、配列の0番目の値を取ってくるので、`console.log(result[0]);`としてあげる。


https://zenn.dev/kawaxumax/articles/0044a0e30536e2

https://qiita.com/niusounds/items/37c1f9b021b62194e077


- ここまで実装したら、ローカルのブラウザ環境で試してみる。
- そうすると以下の画像のように、ボタンを押すとAPIが動いて、情報が出力されたことがわかる。

<br>

```tsx
// index.tsx
import Head from 'next/head'
import Image from 'next/image'
import { Inter } from 'next/font/google'
import styles from '@/styles/Home.module.css'

const inter = Inter({ subsets: ['latin'] })

export default function Home() {
  const fetchCatImage = async () => {
    const res = await fetch("https://api.thecatapi.com/v1/images/search");
    const result = await res.json();
    console.log(result[0]);
  };
  return (
    <div className={styles.container}>
      <h1>猫画像アプリ</h1>
      <img src="https://cdn2.thecatapi.com/images/1v1.jpg" alt="cat_image" />
      <button onClick={fetchCatImage}>
        今日の猫さん
      </button>
    </div>
  );
};
```

<br>

<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3486945/d577ddc4-d642-aadd-fcdd-c5882811093a.jpeg" alt="代替テキスト" width=50% height=50%>

- いったん、ここまで。
- ここまでのコードは`JavaScript`である。
- まだ`TypeScript`は使っていない。

<br>

***<font color="Red">動画10分00秒付近から</font>***

- 先の実装では`fetchCatImage`関数のなかで`console.log`で出力していたが、のちに実装する`handleClick`に対応するために、、、
- このコードをコメントアウトし、新たに`return result[0]`としてAPI取得した要素をブラウザに表示させるようにします。

```tsx
export default function Home() {
  const fetchCatImage = async () => {
    const res = await fetch("https://api.thecatapi.com/v1/images/search");
    const result = await res.json();
    // console.log(result[0]);
    return result[0];
  };
```


<br>

- 続いて、先ほどの実装では`fetchCatImage`関数を`onClick`でAPIを呼び出していたが、
- 今度は新しく`handleClick`という関数を作り、その処理の中で`fetchCatImage`を呼び出すように変更します。
- これは詳しくは今の所不明だけれど、そうするもんだと思っておこう。。。。
- この記事が参考になるかも？

https://qiita.com/jima-r20/items/839da7c2f26366491298

- `handleClick`という関数を別で用意する意味としては、メソッドが増えたときに構文が長くならないようにするための処置なのかなぁ、、、？
- ここまでのコード実装は以下の通り。

```tsx
export default function Home() {
  const fetchCatImage = async () => {
    const res = await fetch("https://api.thecatapi.com/v1/images/search");
    const result = await res.json();
    // console.log(result[0]);
    return result[0];
  };

  const handleClick = async () => {
    const catImage = await fetchCatImage();
    console.log(catImage);
  };

  return (
    <div className={styles.container}>
      <h1>猫画像アプリ</h1>
      <img src="https://cdn2.thecatapi.com/images/1v1.jpg" alt="cat_image" />
      <button onClick={handleClick}>
        今日の猫さん
      </button>
    </div>
  );
};
```
- 上記のように実装すると、先のコードと結果が同じになる。
- つまり、うまく挙動を変えずにリファクタリング(?)できたことになる。


<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3486945/61a0507c-eb46-651c-4f92-4420b7a85139.jpeg" alt="代替テキスト" width=50% height=50%>

- 結果は同じで、中身のコードをきれいにできた。
- 汎用性の高いコードにできた？とでもいうべきかな？
- ここで一旦コミットしておきたい。


***<font color="Red">動画11分30秒付近から</font>***

- ここまではJavaScriptの実装。
- このままでも良いのだが、、、、
- 例えば`<button onClick={handleClick.alt}>`のように存在しないプロパティ`alt`を指定すると、エラーになる。
- なぜなら、`alt`プロパティは定義していないから。
- JavaScriptだとここのエラーに気づきづらいのがデメリット。
- js？html？にコンパイルされた時点でエラーが発覚してくれると、気づきやすい。
- ここを解消してくれるのがTypeScriptということになる。
- では、次にTypeScriptでの実装をおこなっていく。

<br>

<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3486945/58bfa402-84dc-c85e-a9c8-d3af95d0d736.jpeg" alt="代替テキスト" width=50% height=50%>

<br>

### ***<font color="orange">TypeScriptを用いた実装！</font>***

***<font color="Red">動画13分20秒付近から</font>***

- 関数コンポーネントの外側、上に追記していきます。
- `interface`というメソッド?を使用します。
- 名前は`SearchCatImage`とします。（任意）
- `height` `id`  `url` `width`という4つのプロパティだけを、`型指定`してあげる。
- 次に、`fetchCatImage`関数に対して、`Promise`メソッド？を用いて、対象を`SearchCatImage`に指定してあげる。
- そうすることで、`SearchCatImage`で指定した4つのプロパティの型だけを取得するように制限をかけられると共に、`VScode`などのテキストエディタ上での実装の段階で、エラーのポップアップが表示されるようになる！
- これは便利！

```diff_tsx
+ interface SearchCatImage {
+   id: string;
+   url: string;
+   width: number;
+   height: number;
+ }

export default function Home() {
+ const fetchCatImage = async (): Promise<SearchCatImage> => {
    const res = await fetch("https://api.thecatapi.com/v1/images/search");
    const result = await res.json();
    // console.log(result[0]);
    return result[0];
  };
```

- すると、エラーが`VScode`の実装段階で気づけるようになった！

<br>

<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3486945/b03dd876-684a-c66a-2c52-a98a5494c718.jpeg" alt="代替テキスト" width=50% height=50%>

<br>


- エラーに気づきやすくなったところで、
- 次に、取得する情報をurlに限定してあげる。

```diff_tsx
  const handleClick = async () => {
    const catImage = await fetchCatImage();
+   console.log(catImage.url);
  };
```

- TypeScriptの重要項目の実装はいったん、ここまで。
- コミットしておきます。

<br>


### ***<font color="orange">取得した猫画像URLを画面に出力</font>***

***<font color="Red">動画16分20秒付近から</font>***

- 現在は、特定のURLの`src`ソースを指定している状態。
- この状態を`ハードコーティング`と呼ぶらしい。
- このハードコーティングの状態から、ボタンを押した時に、APIで毎回引っ張ってきたURLを挿入すれば良い。
- そのためには`変数`を定義する。
- 変数名は`catImageUrl`とする。


```tsx
<img src={catImageUrl} />
```

- 次に、名付けた`catImageUrl`変数を、状態変数として中身を実装していく。

```diff_tsx
const Home: NextPage = () = {
+ const [catImageUrl, setCatImageUrl] = useState("");
//以下省略
```
- 上記のように、HOMEの関数コンポーネントのすぐ下にコードを追記する。
- `useState("");`は状態変数を意味するメソッド？
- ここの記述は`React`を使っているらしい。

https://zenn.dev/pu_ay/articles/99df8c9175a5f0

```tsx
const [状態変数, 状態を変更するための関数] = useState(状態の初期値)
```
- これはReactの構文であり、独自のルールとして存在するらしい。

:::note warn
- 引数の中は一旦、空にしておく。
- 後でここの値は`SSG`を用いたコードを記述していくので。
- なお、`("")`ダブルクォーテーションで囲まないとエラーになるので注意。
- ここのエラーも`VScode`上で指摘してくれるので、やはりTypeScript優秀！
:::

- Reactを使った状態変数の定義が出来たので、次に、この変数を使って猫画像URLをブラウザで表示するようにする。
- 具体的には先に実装したボタンクリック時の挙動の関数`handleClick`に対し実装する。
- 現在、`console.log(catImage.url);`となっており、コンソールで出力する感じになっている。
- これを消して修正していく。

```diff_tsx
  const handleClick = async () => {
    const catImage = await fetchCatImage();
+   setCatImageUrl(catImage.url);
  };
```
- これでOK。
- ボタンクリック時にイベントが発火して？APIで取得したURLを、htmlタグである`<img src={catImageUrl} />`に出力してくれるようになる。

<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3486945/ae5838da-964b-c692-ad1d-426c4cc8a0ba.jpeg" alt="代替テキスト" width=50% height=50%>

<br>

👆ここで一旦コミットしておく。

<br>

- 現状のソースコード

```diff_tsx
  import Head from 'next/head'
  import Image from 'next/image'
  import { Inter } from 'next/font/google'
  import styles from '@/styles/Home.module.css'
+ import { useState } from 'react'

const inter = Inter({ subsets: ['latin'] })

interface SearchCatImage {
  id: string;
  url: string;
  width: number;
  height: number;
}

export default function Home() {
+ const [catImageUrl, setCatImageUrl] = useState("");
  const fetchCatImage = async (): Promise<SearchCatImage> => {
    const res = await fetch("https://api.thecatapi.com/v1/images/search");
    const result = await res.json();
    // console.log(result[0]);
    return result[0];
  };

  const handleClick = async () => {
    const catImage = await fetchCatImage();
    console.log(catImage.url);
+   // console.log(catImage.url);
+   setCatImageUrl(catImage.url);
  };

  return (
    <div className={styles.container}>
      <h1>猫画像アプリ</h1>
      <img src="https://cdn2.thecatapi.com/images/1v1.jpg" alt="cat_image" />
+     <img src={catImageUrl} alt="cat_image" />
      <button onClick={handleClick}>
        今日の猫さん
      </button>
    </div>
  );
};
```

:::note info
- Reactのメソッド？である`useState`を使用すると、自動的に`import { useState } from 'react'`を定義してくれている！
- `TypeScript`か`Next.js`の標準装備？なのか分からないけど、凄い！！
:::

<br>


### ***<font color="orange">ブラウザリロード時にAPIが作動するようにSSRを実装する</font>***

***<font color="Red">動画18分22秒付近から</font>***

<br>

<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3486945/3a81d405-c720-7ddf-f061-e1e8fb168995.jpeg" alt="代替テキスト" width=50% height=50%>

<br>


- 現状、indexページをリロードした最初の画面では、
- 画像が表示されていない状態。
- これをリロードした時点から猫画像APIを取得してくれるようにしていく。
- 具体的には`Next.js`で扱える`SSR（サーバーサイドプロップス）`という機能を実装する。

<br>

***<font color="Blue">SSRとSSGの違いと使い分け方</font>***

- `SSG`は`Static Site Generator`の略で日本語で「`静的生成`」という意味。
- 例えばクライアントであるブラウザから`indexページ`をリクエストしたときに、、、
- あらかじめデータを用意しておくことで、読み込み速度が格段に早くなるという機能。
- これは静的なデータを対象にした場合に使える。
- ただし、今回のようなAPIを取得するという挙動は動的なデータであるため、`SSGは使えない`。

<br>

- 対して`SSR`は、`サーバーサイドレンダリング、もしくはサーバーサイドプロップス`と呼ばれており、Webページを生成する際にサーバーサイドでHTMLを生成し、クライアントに送信する`Next.js`の機能を指す。
- こちらも、SSGと同様、ページの読み込み速度が速くなるメリットがある。
- また、`SSG`とは違い、サーバー側でデータを取ってくる挙動を示すので、`動的なデータ`に対しても使うことができるのがメリット。

<br>

- どのように使い分けるかは、現在の自分の知識ではそこまで理解していないが、簡単な静的サイトの表示であればSSG、APIを叩くような動的データを取得するページのレンダリングに関してはSSRを使用する。。。。
- といった使い分け方ができるのではないかと想像しています。
- 間違ってたらすいません。

<br>

***<font color="orange">話を戻して、改めてSSRを実装していく</font>***

***<font color="Red">動画18分22秒付近から</font>***

- 記述する場所は`return`文の上か下
- どっちでもよいが、今回は`return`文の下に記述していく。
- 今回は`getServerSideProps`という`Next.js標準装備のメソッド？`を利用する。
- 型は、こちらもNext.js標準サポートの`GetServerSideProps`という型を利用する。

```tsx
export const getServerSideProps: GetServerSideProps<>;
```

https://www.commte.co.jp/learn-nextjs/getServerSideProps

- ここを記述すると、自動的に`import構文`も生成してくれている。サンキュー！

```tsx
import { GetServerSideProps } from 'next'
```

- 次に、``のジェネリックにお手製の型を用意してあげる。
- 任意の名前で今回は``とする。
- なお、ジェネリックとは日本語で、一般的な、包括的な、という意味。
- ジェネリック医薬品では、包括的な名前にすることで、後発の医薬品を患者が選択することができるわけだ。
- Next.jsでは、URLの`string型`とか、数字の`number型`などを指定できるのに加え、
- 今回のように`interface`を活用した`お手製の型`を`GetServerSideProps`に指定することができる。

https://www.commte.co.jp/docs/typescript-beginner

- `ジェネリック`を使用すると、`型の柔軟性を保ちながら、型安全性を維持できる`のがメリット。
- ひとまず以下のように実装した。


```tsx
interface IndexPageProps {
  initialCatImageUrl: string;
}

// 中略

export const getServerSideProps: GetServerSideProps<IndexPageProps>;
```

- 定義した`IndexPageProps`。
- ここにAPIで取得した猫画像のURLが入るようにしていくわけだ。
- ここでも`async`関数を使用して、非同期処理で実装する。

```tsx
export const getServerSideProps: GetServerSideProps<
    IndexPageProps
    > = async () => {
    
    };
```

- 行が長くなるときは、上記のように改行できるようだ。
- 今回はブラウザをリロードしたタイミングにサーバーサイドでAPI取得してレンダリングしてフェッチングしてくるように実装したい。
- 

```diff_tsx
// SSR
export const getServerSideProps: GetServerSideProps<
  IndexPageProps
> = async () => {
+ const catImage = await fetchCatImage();
};
```

- と、ここでエラー発生
- `fetchCatImage`が見つかりません。となっている。

<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3486945/81998cb8-f564-278f-2532-38643908a8a4.jpeg" alt="代替テキスト" width=50% height=50%>

- 猫画像を取得するAPIを実装した`fetchCatImage`関数が取れてこれていないようだ。
- 原因は、`fetchCatImage`関数を実装した場所にある。
- `Home`関数コンポーネントの内部に実装しているのがダメっぽいので、外側上にこの関数を移動させてあげる。


```diff_tsx
interface IndexPageProps {
  initialCatImageUrl: string;
}

+   const fetchCatImage = async (): Promise<SearchCatImage> => {
+     const res = await fetch("https://api.thecatapi.com/v1/images/search");
+     const result = await res.json();
+     // console.log(result[0]);
+     return result[0];
+   };

export default function Home() {
  const [catImageUrl, setCatImageUrl] = useState("");

- 
- 
  const handleClick = async () => {
    const catImage = await fetchCatImage();
    // console.log(catImage.url);
    setCatImageUrl(catImage.url);
  };
```

- これで`fetchCatImage関数が取得できない`エラーが解消される。

<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3486945/b50feba2-71c9-f3da-e4ab-7ed63ab3cb31.jpeg" alt="代替テキスト" width=50% height=50%>

- 次に、`return`文で返してあげる。何を？
- 猫画像のURL（String型）を返してあげる。
- プロパティには`props: {}`というものを使用する。
- これは公式ドキュメントでも解説されている構文のようだ。

```diff_tsx
    export const getServerSideProps: GetServerSideProps<
      IndexPageProps
    > = async () => {
      const catImage = await fetchCatImage();
+     return {
+       props: {
+         initialCatImageUrl: catImage.url,
+       },
+     };
    };
```

- ここまでを整理すると、、、、

:::note info
- ブラウザリロード時にも、`API`で猫画像を引っ張ってきたいので、、、
- `Next.js`で標準サポートされている`GetServerSideProps`を使い、
- ジェネリックには任意で名付けた、`sring型のURL`を指定する`interface`である`IndexPageProps`を定義した。
- 先に実装済みの`fetchCatImage`関数を呼び出し、猫画像APIを叩くようにここで再利用して、
- 公式で解説されている`return { props: {} }`構文を使い、
- `interface`で定義づけた`IndexPageProps`の中にある変数`initialCatImageUrl`すなわち`catImage.url`という`Sring型`のURL情報を返すというところまで実装した。
:::

- だが、ここで終わりではない。
- 最後に、この実装した一連のSSRの挙動を、
- 最初のブラウザにアクセスしたとき、リロードしたとき、
- すなわちクライアントがHTTPリクエストを送ってきたときに、返すようにしなければならない。
- それはどうやるのか？
- 具体的には、`Homeコンポーネント`に渡してあげる。
- 何を？
- `SSR`で実装した`IndexPageProps`ジェネリックに定義した変数`initialCatImageUrl`を指定してあげる。ここには`catImage.url`という`Sring型`のURL情報が入っている。


```tsx
// 変更前

export default function Home() {
  const [catImageUrl, setCatImageUrl] = useState("");

```

- `export default function Home() {};`というHomeコンポーネント？に諸々の実装をしていたが、なんかこれは違うっぽいので削除。
- 動画で解説されている通り、Home関数コンポーネントを`アロー関数`で指定してあげた。
- 最終的には下記のように実装することで解決した。



```tsx
// 変更後
const Home: NextPage<IndexPageProps> = ( {initialCatImageUrl} ) => {
  const [catImageUrl, setCatImageUrl] = useState(initialCatImageUrl);

// 中略
export default Home;

```

:::note alert
なお、`export default Home;`を最後に記述しておかないとエラーになる。
エラーの内容は下記の通り。

`Error: The default export is not a React Component in page: "/"`

:::


<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3486945/cac66f6c-ac98-7668-3e18-3dba60767054.jpeg" alt="代替テキスト" width=50% height=50%>


- ひとまずこれで完成となります。
- ここでコミットしておきます。
- ここまでのソースコードは以下の通り。

```tsx
//index.tsx

import Head from 'next/head'
import Image from 'next/image'
import { Inter } from 'next/font/google'
import styles from '@/styles/Home.module.css'
import { useState } from 'react'
import { GetServerSideProps, NextPage } from 'next'

const inter = Inter({ subsets: ['latin'] })

interface SearchCatImage {
  id: string;
  url: string;
  width: number;
  height: number;
}

interface IndexPageProps {
  initialCatImageUrl: string;
}

const fetchCatImage = async (): Promise<SearchCatImage> => {
  const res = await fetch("https://api.thecatapi.com/v1/images/search");
  const result = await res.json();
  // console.log(result[0]);
  return result[0];
};

const Home: NextPage<IndexPageProps> = ( {initialCatImageUrl} ) => {
  const [catImageUrl, setCatImageUrl] = useState(initialCatImageUrl);

  const handleClick = async () => {
    const catImage = await fetchCatImage();
    // console.log(catImage.url);
    setCatImageUrl(catImage.url);
  };

  return (
    <div className={styles.container}>
      <h1>猫画像アプリ</h1>
      <img src={catImageUrl} alt="cat_image" />
      <button onClick={handleClick}>
        今日の猫さん
      </button>
    </div>
  );  
};

// SSR
export const getServerSideProps: GetServerSideProps<
  IndexPageProps
> = async () => {
  const catImage = await fetchCatImage();
  return {
    props: {
      initialCatImageUrl: catImage.url,
    },
  };
};

export default Home;

```


<br>


### ***<font color="orange">おまけの実装〜 Now loading 〜</font>***

***<font color="Red">動画27分09秒付近から</font>***

- 最後に、おまけの実装をしていく。
- ボタンをクリックして画像が表示されるまでの間のローディング中に何か待たせていることを知らせる機能を追加していきます。
- 今回は、`semantic ui`という`CSSフレームワーク`を利用していきます。
- `React`で`semantic ui`を利用できるこちらのサイトを利用します。

https://react.semantic-ui.com/


- こちらのサイトの`Get Started`のページを参考に導入・実装を進めていきます。
- まずはインストールします。
- `yarn`か`npm`かでコマンドが異なります。


```terminal
$  yarn add semantic-ui-react semantic-ui-css
## Or NPM
$  npm install semantic-ui-react semantic-ui-css
```

- コマンドを叩くとこんな感じになりました。

```terminal
added 16 packages, and audited 299 packages in 9s

108 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities
```

- インストールすると、`package.json`と`package-lock.json`が更新されます。

```terminal
git status -u
On branch development
Your branch is up to date with 'origin/development'.

Changes not staged for commit:
  (use "git add <file>..." to update what will be committed)
  (use "git restore <file>..." to discard changes in working directory)
	modified:   package-lock.json
	modified:   package.json
```

- 次に、`semantic ui`を開発中のプロジェクトで読み込むための`import文`を記述します。


```diff_tsx
// index.tsx

  import { useState } from 'react'
  import { GetServerSideProps, NextPage } from 'next'
+ import 'semantic-ui-css/semantic.min.css'

// 以下省略
```

- 次に、実際に使用したいローディン中のアイコンを実装するにあたり、`Loader`というものを`semantic ui`から`import`する構文を記述します。


```diff_tsx
// index.tsx

  import { useState } from 'react'
  import { GetServerSideProps, NextPage } from 'next'
  import 'semantic-ui-css/semantic.min.css'
+ import { Loader } from 'semantic-ui-react'

// 以下省略
```

- 続いて、`import`した`Loader`を、ボタンクリックの際に出るように、以下の場所に`<Loader active />`と記述します。
- `Loader`で先ほどimportした機能をここで使うという宣言となり、
- `acrive`を付けることでローディン中のアイコンを有効にさせることができます。


```diff_tsx
// index.tsx

  return (
    <div className={styles.container}>
      <h1>猫画像アプリ</h1>
      <img src={catImageUrl} alt="cat_image" />
+     <Loader active />
      <button onClick={handleClick}>
        今日の猫さん
      </button>
    </div>
  );  
};
```

<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3486945/80b9e21b-d6ec-ab3b-6350-a3789fd16431.jpeg" alt="代替テキスト" width=50% height=50%>

- 一応アイコンを表示させることに成功したが、
- このままだと、ずっとアイコンが出たままの状態。
- 続いて、ローディン中の時だけに、このアイコンを出すようにしたいので、その実装を行います。
- 具体的には`is loading`という状態変数を新たに定義していきます。


***<font color="Red">動画29分23秒付近から</font>***

- 状態変数`isLoading`の定義場所は、
- Home関数コンポーネントの直下、先に定義した`catImageUrl`の直下に記述していきます。
- ここらへんの記述は、TypeScriptと関係ないが、おまけの実装ということでやっていきます。

```diff_tsx
// index.tsx

const Home: NextPage<IndexPageProps> = ( {initialCatImageUrl} ) => {
  const [catImageUrl, setCatImageUrl] = useState(initialCatImageUrl);
+ const [isLoading, setIsLoading] = useState(false);
```

- 最初の状態の`useState(false);`としておく。
- そして、ボタンがクリックされた時、すなわち`handleClick`関数が実行されるタイミングで、
- `isLoading`が実行されるようにします。
- ボタンクリックで`setIsLoading(true);`として、
- ローディング終了で`setIsLoading(false);`としてあげる。
- 簡単❗️

```diff_tsx
// index.tsx

  const handleClick = async () => {
+   setIsLoading(true);
    const catImage = await fetchCatImage();
    setCatImageUrl(catImage.url);
+   setIsLoading(false);
  };
```

- 次に、`setIsLoading(true);`であれば、アイコンを表示させて、
- `setIsLoading(false);`となったら、猫画像を表示させる。
- このように考えて実装する。
- 場所は`return`構文の中で記述する。
- コーディングは`三項演算子`を用いて記述していきます。

<hr>

- `{isLoading ? }`が`true`であった場合に、
- `<Loader active />`としてローディング中アイコンを表示させる。
- そしてローディングが成功したら、猫画像（URL）を表示させる。


```tsx
// index.tsx

{isLoading ? <Loader active />: <img src={catImageUrl} alt="cat_image" />}

```

- 三項演算子をわかりやすく表現するために、以下のように改行することもできる。
- こっちの方が見た目的にわかりやすいかも？


```tsx
// index.tsx

      {isLoading ? (
        <Loader active />
      ) : (
        <img src={catImageUrl} alt="cat_image" />
      )}
```

:::note info
- `true`ならアイコンを表示させて、、
- 読み込みが終了して`false`になったら
- `猫画像`を表示させる。
:::


<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3486945/a6f73d7f-8682-4a40-5197-6a31e1af8b8e.jpeg" alt="代替テキスト" width=50% height=50%>


<img src="https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3486945/68eb608e-0f7e-2f9c-5ece-004dfa7fd7a4.jpeg" alt="代替テキスト" width=50% height=50%>


- 以上で終了❗️
- お疲れ様でした。
- コミット・プルリクエスト・マージして終了とします。







<br><br><br><br><br><br><br>


## <font color="Seablue">よく使うタグ</font>

`## <font color="seablue">シーブルー</font>`

`#### <font color="salmon">サーモンピンク</font>`

`<img src="" alt="代替テキスト" width=50% height=50%>`

`<a href="" target="_blank">テキスト</a>`

`***<font color="Red">動画05分20秒付近から</font>***`

<br><br><br><br>
